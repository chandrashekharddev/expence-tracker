<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Dashboard - MyMoney.Ai</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #f72585;
            --info-color: #7209b7;
            --purple-color: #7209b7;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .stats-card {
            border-radius: 12px;
            transition: transform 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .recent-transaction {
            transition: transform 0.2s;
        }
        
        .recent-transaction:hover {
            transform: translateX(5px);
        }
        
        .spending-progress {
            height: 6px;
            border-radius: 3px;
        }
        
        .border-purple {
            border-color: var(--purple-color) !important;
        }
        
        .text-purple {
            color: var(--purple-color) !important;
        }
        
        .bg-purple {
            background-color: var(--purple-color) !important;
        }
        
        .bg-purple-opacity-10 {
            background-color: rgba(114, 9, 183, 0.1) !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .chart-wrapper {
            position: relative;
        }
        
        .category-breakdown .progress {
            height: 8px;
        }
        
        /* Custom scrollbar */
        .recent-transactions {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .recent-transactions::-webkit-scrollbar {
            width: 6px;
        }
        
        .recent-transactions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .recent-transactions::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .recent-transactions::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .budget-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .budget-input {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .budget-edit-btn {
            background: none;
            border: none;
            color: #4361ee;
            cursor: pointer;
            padding: 4px;
        }
        
        .budget-edit-btn:hover {
            color: #3a0ca3;
        }
        
        .budget-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-transaction {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .modal-transaction:last-child {
            border-bottom: none;
        }
        
        /* Budget Alert Styles */
        .budget-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.5s ease-out;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-radius: 10px;
            border: none;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .budget-warning {
            animation: pulse 2s infinite;
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .alert-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        /* Budget card warning state */
        .budget-card-warning {
            border: 2px solid #f8961e !important;
            box-shadow: 0 0 15px rgba(248, 150, 30, 0.3);
        }
        
        .budget-card-danger {
            border: 2px solid #f72585 !important;
            box-shadow: 0 0 15px rgba(247, 37, 133, 0.3);
        }
        
        .budget-card-critical {
            animation: pulse 1s infinite;
            border: 2px solid #dc3545 !important;
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.4);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Budget Alert Container -->
    <div id="budget-alert-container" style="position: fixed; top: 80px; right: 20px; z-index: 1050;"></div>
    
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-white bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand text-primary fw-bold" href="index.html">
                <i class="bi bi-wallet2 me-2"></i>MyMoney.Ai
            </a>
            <div class="d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="periodMenu" data-bs-toggle="dropdown">
                        <i class="bi bi-calendar-range me-1"></i> <span id="periodText">This Month</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="changePeriod('week')">This Week</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changePeriod('month')">This Month</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changePeriod('year')">This Year</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changePeriod('all')">All Time</a></li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown">
                        <i class="bi bi-person me-1"></i> <span id="username">User</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item active" href="#"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
                        <li><a class="dropdown-item" href="index.html"><i class="bi bi-chat-dots me-2"></i>Expense Chat</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Content -->
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="fw-bold">Expense Dashboard</h2>
                    <button class="btn btn-primary" onclick="location.href='index.html'">
                        <i class="bi bi-plus-circle me-2"></i>Add Expense
                    </button>
                </div>
                <p class="text-muted">Track and analyze your spending patterns</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4" id="stats-cards">
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-white p-4 shadow-sm fade-in">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Total Spent</h6>
                            <h3 class="fw-bold" id="total-spent">₹0</h3>
                            <span class="text-muted small" id="total-period">This month</span>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-cash-stack text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-white p-4 shadow-sm fade-in">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Daily Average</h6>
                            <h3 class="fw-bold" id="daily-average">₹0</h3>
                            <span class="text-muted small" id="avg-period">This month</span>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-graph-up-arrow text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-white p-4 shadow-sm fade-in">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Total Transactions</h6>
                            <h3 class="fw-bold" id="total-transactions">0</h3>
                            <span class="text-muted small" id="transactions-period">This month</span>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-receipt text-warning fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="stats-card bg-white p-4 shadow-sm fade-in" id="budget-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Budget Remaining</h6>
                            <div class="budget-display">
                                <h3 class="fw-bold" id="budget-remaining">₹20,000</h3>
                                <button class="budget-edit-btn" onclick="editBudget()" title="Edit Budget">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </div>
                            <div class="budget-input-container" id="budget-input-container" style="display: none;">
                                <input type="number" class="budget-input" id="budget-input" placeholder="Enter budget amount" min="0" step="100">
                                <button class="btn btn-sm btn-success" onclick="saveBudget()">Save</button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelBudgetEdit()">Cancel</button>
                            </div>
                            <span class="text-muted small" id="budget-text">of ₹20,000 budget</span>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-piggy-bank text-info fs-4"></i>
                        </div>
                    </div>
                    <div class="progress spending-progress mt-3">
                        <div class="progress-bar bg-success" id="budget-progress" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
            <!-- Spending by Category Chart -->
            <div class="col-xl-6">
                <div class="chart-container h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Spending by Category</h5>
                        <select class="form-select form-select-sm w-auto" id="categoryChartRange" onchange="updateCategoryChart()">
                            <option value="month">This Month</option>
                            <option value="week">This Week</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Trend Chart -->
            <div class="col-xl-6">
                <div class="chart-container h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Monthly Spending Trend</h5>
                        <select class="form-select form-select-sm w-auto" id="trendChartRange" onchange="updateTrendChart()">
                            <option value="6">Last 6 Months</option>
                            <option value="12">Last 12 Months</option>
                            <option value="3">Last 3 Months</option>
                        </select>
                    </div>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row: Recent Transactions & Category Breakdown -->
        <div class="row g-4">
            <!-- Recent Transactions -->
            <div class="col-xl-6">
                <div class="chart-container h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Recent Transactions</h5>
                        <a href="#" class="text-primary text-decoration-none small" onclick="loadAllTransactions()">View All</a>
                    </div>
                    <div class="recent-transactions" id="recent-transactions">
                        <!-- Transactions will be loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading transactions...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!--Category Breakdown -->
             <div class="col-xl-6">
                <div class="chart-container h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Category Breakdown</h5>
                        <span class="text-muted small" id="breakdown-period">This Month</span>
                    </div>
                    
                    <div class="category-breakdown" id="category-breakdown">
                        <!-- Category breakdown will be loaded here -->
                         <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading category data...</p>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>

    <!-- All Transactions Modal -->
    <div class="modal fade" id="allTransactionsModal" tabindex="-1" aria-labelledby="allTransactionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allTransactionsModalLabel">All Transactions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="transactionSearch" placeholder="Search transactions..." onkeyup="filterTransactions()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="transactionFilter" onchange="filterTransactions()">
                                <option value="all">All Categories</option>
                                <option value="Food">Food</option>
                                <option value="Clothes">Clothes</option>
                                <option value="Transport">Transport</option>
                                <option value="Bills">Bills</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div id="all-transactions-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- All transactions will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportTransactions()">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration
        const BACKEND_URL = "https://aiexpensetracker-p7ux.onrender.com";
        let USER_ID = localStorage.getItem('user_id') || 'user_001';
        
        // Chart instances
        let categoryChart, trendChart;
        
        // Current period
        let currentPeriod = 'month';
        
        // User budget (default 20000)
        let userBudget = localStorage.getItem(`budget_${USER_ID}`) || 20000;
        
        // Store all transactions for filtering
        let allTransactions = [];
        
        // Track if budget alert has been shown
        let budgetAlertShown = false;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }
            
            USER_ID = userId;
            
            // Load user budget from localStorage
            const savedBudget = localStorage.getItem(`budget_${USER_ID}`);
            if (savedBudget) {
                userBudget = parseInt(savedBudget);
            }
            
            // Set username
            const username = localStorage.getItem('username') || USER_ID;
            document.getElementById('username').textContent = username;
            
            // Load all data
            loadDashboardData();
            
            // Initialize empty charts
            initializeCharts();
            
            // Check for budget alerts on load
            setTimeout(checkBudgetAlerts, 1000);
        });
        
        // Check authentication
        function checkAuth() {
            const userId = localStorage.getItem('user_id');
            if (!userId) {
                window.location.href = 'login.html';
                return null;
            }
            return userId;
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load expenses
                const response = await fetch(`${BACKEND_URL}/expenses?user_id=${USER_ID}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                const expenses = data.expenses || [];
                allTransactions = expenses; // Store for filtering
                
                // Update dashboard with real data
                updateDashboardStats(expenses);
                updateRecentTransactions(expenses);
                updateCategoryBreakdown(expenses);
                updateCharts(expenses);
                
                // Check for budget alerts
                checkBudgetAlerts();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data. Please try again.');
            }
        }
        
        // Update dashboard statistics
        function updateDashboardStats(expenses) {
            let total = 0;
            let transactions = expenses.length;
            
            // Calculate totals
            expenses.forEach(expense => {
                total += expense[4] || 0; // amount at index 4
            });
            
            // Calculate daily average (for current month)
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dailyAverage = total / daysInMonth;
            
            // Calculate budget remaining
            const budget = parseInt(userBudget);
            const budgetRemaining = budget - total;
            const budgetPercentage = budget > 0 ? (total / budget) * 100 : 0;
            
            // Update UI
            document.getElementById('total-spent').textContent = `₹${total.toFixed(2)}`;
            document.getElementById('daily-average').textContent = `₹${dailyAverage.toFixed(2)}`;
            document.getElementById('total-transactions').textContent = transactions;
            document.getElementById('budget-remaining').textContent = `₹${Math.max(budgetRemaining, 0).toFixed(2)}`;
            document.getElementById('budget-text').textContent = `of ₹${budget.toLocaleString('en-IN')} budget`;
            
            // Update budget progress bar
            const progressBar = document.getElementById('budget-progress');
            const progressPercentage = Math.min(budgetPercentage, 100);
            progressBar.style.width = `${progressPercentage}%`;
            
            // Change color based on budget usage
            const budgetCard = document.getElementById('budget-card');
            
            // Remove all alert classes first
            budgetCard.classList.remove('budget-card-warning', 'budget-card-danger', 'budget-card-critical');
            
            if (progressPercentage >= 100) {
                // Budget exceeded
                progressBar.classList.remove('bg-success', 'bg-warning');
                progressBar.classList.add('bg-danger');
                budgetCard.classList.add('budget-card-critical');
                
                // Show critical alert
                if (!budgetAlertShown) {
                    showBudgetAlert('critical', 'Budget Exceeded!', `You have exceeded your budget by ₹${Math.abs(budgetRemaining).toFixed(2)}`, true);
                    budgetAlertShown = true;
                }
                
            } else if (progressPercentage > 80) {
                // Budget almost exceeded (80-100%)
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-danger');
                budgetCard.classList.add('budget-card-danger');
                
                // Show warning alert
                if (!budgetAlertShown) {
                    showBudgetAlert('danger', 'Budget Warning!', `You've used ${progressPercentage.toFixed(1)}% of your budget. Only ₹${budgetRemaining.toFixed(2)} remaining.`, true);
                    budgetAlertShown = true;
                }
                
            } else if (progressPercentage > 60) {
                // Budget warning (60-80%)
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-warning');
                budgetCard.classList.add('budget-card-warning');
                
                // Show warning alert
                if (!budgetAlertShown) {
                    showBudgetAlert('warning', 'Budget Alert', `You've used ${progressPercentage.toFixed(1)}% of your budget. Be cautious with your spending.`);
                }
                
            } else {
                // Within budget (0-60%)
                progressBar.classList.remove('bg-danger', 'bg-warning');
                progressBar.classList.add('bg-success');
                budgetAlertShown = false; // Reset for next check
            }
            
            // Show daily budget alert if spending too high
            showDailyBudgetAlert(total, budgetRemaining, budgetPercentage);
        }
        
        // Show budget alert notifications
        function showBudgetAlert(type, title, message, persistent = false) {
            const alertContainer = document.getElementById('budget-alert-container');
            
            // Clear existing alerts
            const existingAlerts = alertContainer.querySelectorAll('.budget-alert');
            if (existingAlerts.length > 2) {
                existingAlerts[0].remove();
            }
            
            let alertClass, icon, bgColor, textColor;
            
            switch(type) {
                case 'critical':
                    alertClass = 'alert-danger';
                    icon = 'bi-exclamation-triangle-fill';
                    bgColor = '#dc3545';
                    textColor = 'white';
                    break;
                case 'danger':
                    alertClass = 'alert-danger';
                    icon = 'bi-exclamation-triangle';
                    bgColor = '#dc3545';
                    textColor = 'white';
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    icon = 'bi-exclamation-circle';
                    bgColor = '#ffc107';
                    textColor = '#000';
                    break;
                default:
                    alertClass = 'alert-info';
                    icon = 'bi-info-circle';
                    bgColor = '#0dcaf0';
                    textColor = '#000';
            }
            
            const alertId = 'budget-alert-' + Date.now();
            const alertHTML = `
                <div class="alert ${alertClass} budget-alert ${type === 'critical' ? 'budget-warning' : ''}" 
                     id="${alertId}" 
                     style="background-color: ${bgColor}; color: ${textColor}; border-left: 5px solid ${textColor === 'white' ? '#fff' : '#000'};">
                    <div class="alert-header">
                        <div class="d-flex align-items-center">
                            <i class="bi ${icon} alert-icon"></i>
                            <div>
                                <h6 class="mb-1 fw-bold">${title}</h6>
                                <p class="mb-0 small">${message}</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close ${textColor === 'white' ? 'btn-close-white' : ''}" 
                                onclick="document.getElementById('${alertId}').remove()">
                        </button>
                    </div>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto-remove after some time (unless persistent)
            if (!persistent) {
                setTimeout(() => {
                    const alertElement = document.getElementById(alertId);
                    if (alertElement) {
                        alertElement.style.transition = 'all 0.5s ease';
                        alertElement.style.opacity = '0';
                        alertElement.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            if (alertElement.parentNode) {
                                alertElement.remove();
                            }
                        }, 500);
                    }
                }, 8000);
            }
        }
        
        // Show daily budget alert
        function showDailyBudgetAlert(total, budgetRemaining, budgetPercentage) {
            const today = new Date();
            const currentDay = today.getDate();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            // Calculate daily budget
            const dailyBudget = userBudget / daysInMonth;
            const expectedSpendingByNow = dailyBudget * currentDay;
            
            if (total > expectedSpendingByNow * 1.2) {
                // Spending 20% more than expected for this point in month
                const overspent = total - expectedSpendingByNow;
                showBudgetAlert('warning', 'Daily Spending Alert', 
                    `You're spending ₹${overspent.toFixed(2)} more than your daily budget target. Consider reducing expenses.`);
            }
            
            // Check if on track to exceed budget
            if (budgetPercentage > (currentDay / daysInMonth * 100) * 1.3) {
                showBudgetAlert('warning', 'Spending Pace Alert', 
                    `You're spending faster than your monthly budget pace. At this rate, you'll exceed your budget by month end.`);
            }
        }
        
        // Check for budget alerts
        function checkBudgetAlerts() {
            // This function can be called periodically or after expense updates
            const budgetRemainingElement = document.getElementById('budget-remaining');
            if (budgetRemainingElement) {
                const budgetText = budgetRemainingElement.textContent;
                const remainingAmount = parseFloat(budgetText.replace('₹', '').replace(',', ''));
                
                if (remainingAmount < 0) {
                    const exceededAmount = Math.abs(remainingAmount);
                    showBudgetAlert('critical', 'Budget Exceeded!', 
                        `You have exceeded your budget by ₹${exceededAmount.toFixed(2)}. Consider revising your budget or reducing expenses.`, true);
                } else if (remainingAmount < (userBudget * 0.2)) {
                    // Less than 20% budget remaining
                    showBudgetAlert('danger', 'Low Budget Alert', 
                        `Only ₹${remainingAmount.toFixed(2)} remaining (${((remainingAmount / userBudget) * 100).toFixed(1)}% of budget).`);
                }
            }
        }
        
        // Update recent transactions
        function updateRecentTransactions(expenses) {
            const container = document.getElementById('recent-transactions');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No transactions yet. Add your first expense in the chat!
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => {
                return new Date(b[2]) - new Date(a[2]); // date at index 2
            }).slice(0, 10); // Show only 10 most recent
            
            renderTransactions(sortedExpenses, container);
        }
        
        // Render transactions to a container
        function renderTransactions(expenses, container) {
            let html = '';
            
            expenses.forEach(expense => {
                // expense structure: [id, user_id, date, category, amount, description]
                const id = expense[0];
                const date = expense[2];
                const category = expense[3];
                const amount = expense[4];
                const description = expense[5] || 'Expense';
                
                // Get category color
                const categoryColor = getCategoryColor(category);
                const categoryIcon = getCategoryIcon(category);
                
                html += `
                    <div class="recent-transaction p-3 mb-3 bg-white rounded border-start border-${categoryColor}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="d-flex align-items-center">
                                    <div class="bg-${categoryColor} bg-opacity-10 p-2 rounded me-3">
                                        <i class="bi ${categoryIcon} text-${categoryColor}"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold">${description}</h6>
                                        <small class="text-muted">${category} • ${formatDate(date)}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <h6 class="text-danger mb-0 fw-bold">₹${amount.toFixed(2)}</h6>
                                <small class="text-muted">${formatDate(date, true)}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Update category breakdown
        function updateCategoryBreakdown(expenses) {
            const container = document.getElementById('category-breakdown');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No category data available yet.
                    </div>
                `;
                return;
            }
            
            // Calculate category totals
            const categoryTotals = {};
            expenses.forEach(expense => {
                const category = expense[3] || 'Other';
                const amount = expense[4] || 0;
                
                if (!categoryTotals[category]) {
                    categoryTotals[category] = {
                        total: 0,
                        count: 0
                    };
                }
                
                categoryTotals[category].total += amount;
                categoryTotals[category].count++;
            });
            
            // Calculate overall total
            let overallTotal = 0;
            Object.values(categoryTotals).forEach(cat => {
                overallTotal += cat.total;
            });
            
            // Sort categories by total (highest first)
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([, a], [, b]) => b.total - a.total);
            
            let html = '';
            
            sortedCategories.forEach(([category, data]) => {
                const percentage = overallTotal > 0 ? (data.total / overallTotal) * 100 : 0;
                const color = getCategoryColor(category);
                const icon = getCategoryIcon(category);
                
                html += `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <div class="bg-${color} bg-opacity-10 p-2 rounded me-3">
                                    <i class="bi ${icon} text-${color}"></i>
                                </div>
                                <span class="fw-bold">${category}</span>
                            </div>
                            <span class="fw-bold">₹${data.total.toFixed(2)}</span>
                        </div>
                        <div class="progress spending-progress">
                            <div class="progress-bar bg-${color}" style="width: ${percentage}%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">${percentage.toFixed(1)}% of total</small>
                            <small class="text-muted">${data.count} transaction${data.count !== 1 ? 's' : ''}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Initialize charts
        function initializeCharts() {
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#6c757d'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ₹${context.parsed}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        label: 'Monthly Spending',
                        data: [0],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#4361ee',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `₹${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Update charts with real data
        function updateCharts(expenses) {
            // Update category chart
            const categoryTotals = {};
            expenses.forEach(expense => {
                const category = expense[3] || 'Other';
                const amount = expense[4] || 0;
                
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                
                categoryTotals[category] += amount;
            });
            
            const categoryLabels = Object.keys(categoryTotals);
            const categoryData = Object.values(categoryTotals);
            const categoryColors = categoryLabels.map(cat => getChartColor(cat));
            
            categoryChart.data.labels = categoryLabels;
            categoryChart.data.datasets[0].data = categoryData;
            categoryChart.data.datasets[0].backgroundColor = categoryColors;
            categoryChart.update();
            
            // Update trend chart (group by month)
            const monthlyTotals = {};
            expenses.forEach(expense => {
                const date = new Date(expense[2]);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const amount = expense[4] || 0;
                
                if (!monthlyTotals[monthYear]) {
                    monthlyTotals[monthYear] = 0;
                }
                
                monthlyTotals[monthYear] += amount;
            });
            
            // Sort months chronologically
            const sortedMonths = Object.keys(monthlyTotals).sort();
            const monthLabels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });
            const monthData = sortedMonths.map(month => monthlyTotals[month]);
            
            trendChart.data.labels = monthLabels;
            trendChart.data.datasets[0].data = monthData;
            trendChart.update();
        }
        
        // Update category chart based on range
        function updateCategoryChart() {
            // This would filter expenses by date range in a real implementation
            showToast('Category chart range updated');
        }
        
        // Update trend chart based on range
        function updateTrendChart() {
            // This would filter expenses by date range in a real implementation
            showToast('Trend chart range updated');
        }
        
        // Change period
        function changePeriod(period) {
            currentPeriod = period;
            const periodText = document.getElementById('periodText');
            
            switch(period) {
                case 'week':
                    periodText.textContent = 'This Week';
                    break;
                case 'month':
                    periodText.textContent = 'This Month';
                    break;
                case 'year':
                    periodText.textContent = 'This Year';
                    break;
                case 'all':
                    periodText.textContent = 'All Time';
                    break;
            }
            
            // Update period labels
            document.getElementById('total-period').textContent = periodText.textContent;
            document.getElementById('avg-period').textContent = periodText.textContent;
            document.getElementById('transactions-period').textContent = periodText.textContent;
            document.getElementById('breakdown-period').textContent = periodText.textContent;
            
            // In a real implementation, you would filter expenses by period
            showToast(`Showing data for ${periodText.textContent.toLowerCase()}`);
            
            // Reload data for the selected period
            loadDashboardData();
        }
        
        // Load all transactions - FIXED
        function loadAllTransactions() {
            if (allTransactions.length === 0) {
                showToast('No transactions to display.');
                return;
            }
            
            // Sort by date (newest first)
            const sortedTransactions = [...allTransactions].sort((a, b) => {
                return new Date(b[2]) - new Date(a[2]);
            });
            
            const container = document.getElementById('all-transactions-list');
            let html = '';
            
            if (sortedTransactions.length === 0) {
                html = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No transactions found.
                    </div>
                `;
            } else {
                sortedTransactions.forEach(expense => {
                    const id = expense[0];
                    const date = expense[2];
                    const category = expense[3];
                    const amount = expense[4];
                    const description = expense[5] || 'Expense';
                    const categoryColor = getCategoryColor(category);
                    
                    html += `
                        <div class="modal-transaction" data-category="${category}" data-description="${description.toLowerCase()}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1 fw-bold">${description}</h6>
                                    <small class="text-muted">
                                        <span class="badge bg-${categoryColor}">${category}</span>
                                        • ${formatDate(date, true)}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <h6 class="text-danger mb-0 fw-bold">₹${amount.toFixed(2)}</h6>
                                    <small class="text-muted">ID: ${id}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('allTransactionsModal'));
            modal.show();
        }
        
        // Filter transactions in modal
        function filterTransactions() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
            const filterCategory = document.getElementById('transactionFilter').value;
            const transactions = document.querySelectorAll('.modal-transaction');
            
            transactions.forEach(transaction => {
                const category = transaction.getAttribute('data-category');
                const description = transaction.getAttribute('data-description');
                
                const matchesSearch = description.includes(searchTerm);
                const matchesCategory = filterCategory === 'all' || category === filterCategory;
                
                if (matchesSearch && matchesCategory) {
                    transaction.style.display = 'block';
                } else {
                    transaction.style.display = 'none';
                }
            });
        }
        
        // Export transactions
        function exportTransactions() {
            const data = allTransactions.map(expense => ({
                id: expense[0],
                date: expense[2],
                category: expense[3],
                amount: expense[4],
                description: expense[5] || 'Expense'
            }));
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "ID,Date,Category,Amount,Description\n"
                + data.map(e => `${e.id},${e.date},${e.category},${e.amount},"${e.description}"`).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `transactions_${USER_ID}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Transactions exported successfully!');
        }
        
        // Edit budget function
        function editBudget() {
            document.querySelector('.budget-display').style.display = 'none';
            document.getElementById('budget-input-container').style.display = 'flex';
            document.getElementById('budget-input').value = userBudget;
            document.getElementById('budget-input').focus();
        }
        
        // Save budget function
        function saveBudget() {
            const newBudget = parseInt(document.getElementById('budget-input').value);
            
            if (isNaN(newBudget) || newBudget < 0) {
                showError('Please enter a valid budget amount.');
                return;
            }
            
            userBudget = newBudget;
            
            // Save to localStorage
            localStorage.setItem(`budget_${USER_ID}`, newBudget);
            
            // Update UI
            document.getElementById('budget-input-container').style.display = 'none';
            document.querySelector('.budget-display').style.display = 'flex';
            
            // Reset alert tracking
            budgetAlertShown = false;
            
            // Reload stats to update budget calculations
            loadDashboardData();
            
            showToast(`Budget updated to ₹${newBudget.toLocaleString('en-IN')}`);
            
            // Show confirmation alert
            showBudgetAlert('success', 'Budget Updated', `Your budget has been updated to ₹${newBudget.toLocaleString('en-IN')}`);
        }
        
        // Cancel budget edit
        function cancelBudgetEdit() {
            document.getElementById('budget-input-container').style.display = 'none';
            document.querySelector('.budget-display').style.display = 'flex';
        }
        
        // Show toast notification
        function showToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="bi bi-info-circle text-primary me-2"></i>
                        <strong class="me-auto">Notification</strong>
                        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // Show error message
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header bg-danger text-white">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong class="me-auto">Error</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Utility functions
        function getCategoryColor(category) {
            const cat = category.toLowerCase();
            if (cat.includes('food') || cat.includes('dining') || cat.includes('lunch') || cat.includes('dinner') || cat.includes('grocer')) {
                return 'success';
            } else if (cat.includes('clothes') || cat.includes('clothing') || cat.includes('shirt') || cat.includes('shopping')) {
                return 'primary';
            } else if (cat.includes('transport') || cat.includes('travel') || cat.includes('taxi') || cat.includes('bus') || cat.includes('fuel')) {
                return 'warning';
            } else if (cat.includes('bills') || cat.includes('utilities') || cat.includes('electric') || cat.includes('water') || cat.includes('rent')) {
                return 'info';
            } else if (cat.includes('entertain') || cat.includes('movie') || cat.includes('game')) {
                return 'purple';
            } else {
                return 'secondary';
            }
        }
        
        function getCategoryIcon(category) {
            const cat = category.toLowerCase();
            if (cat.includes('food') || cat.includes('dining') || cat.includes('lunch') || cat.includes('dinner') || cat.includes('grocer')) {
                return 'bi-egg-fried';
            } else if (cat.includes('clothes') || cat.includes('clothing') || cat.includes('shirt') || cat.includes('shopping')) {
                return 'bi-tshirt';
            } else if (cat.includes('transport') || cat.includes('travel') || cat.includes('taxi') || cat.includes('bus') || cat.includes('fuel')) {
                return 'bi-car-front';
            } else if (cat.includes('bills') || cat.includes('utilities') || cat.includes('electric') || cat.includes('water') || cat.includes('rent')) {
                return 'bi-lightning-charge';
            } else if (cat.includes('entertain') || cat.includes('movie') || cat.includes('game')) {
                return 'bi-ticket-perforated';
            } else {
                return 'bi-cash';
            }
        }
        
        function getChartColor(category) {
            const cat = category.toLowerCase();
            if (cat.includes('food') || cat.includes('dining') || cat.includes('lunch') || cat.includes('dinner') || cat.includes('grocer')) {
                return '#4cc9f0';
            } else if (cat.includes('clothes') || cat.includes('clothing') || cat.includes('shirt') || cat.includes('shopping')) {
                return '#4361ee';
            } else if (cat.includes('transport') || cat.includes('travel') || cat.includes('taxi') || cat.includes('bus') || cat.includes('fuel')) {
                return '#f8961e';
            } else if (cat.includes('bills') || cat.includes('utilities') || cat.includes('electric') || cat.includes('water') || cat.includes('rent')) {
                return '#7209b7';
            } else if (cat.includes('entertain') || cat.includes('movie') || cat.includes('game')) {
                return '#f72585';
            } else {
                return '#6c757d';
            }
        }
        
        function formatDate(dateString, full = false) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (!full) {
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
            }
            
            return date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function logout() {
            // Clear user data
            localStorage.removeItem('user_id');
            localStorage.removeItem('username');
            localStorage.removeItem('user_email');
            
            alert('Logged out successfully!');
            window.location.href = 'login.html';
        }
        
        // Add animation to cards
        const cards = document.querySelectorAll('.fade-in');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });
    </script>
</body>
</html>
